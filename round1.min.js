import{initializeApp}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";import{getDatabase,ref,set,push,get}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";const firebaseConfig={apiKey:"AIzaSyAoFcqKMYnU1pfF8pVBk6oxusVxgAzb1oQ",authDomain:"ciphertrace-26b33.firebaseapp.com",databaseURL:"https://ciphertrace-26b33-default-rtdb.firebaseio.com",projectId:"ciphertrace-26b33",storageBucket:"ciphertrace-26b33.firebasestorage.app",messagingSenderId:"965143042848",appId:"1:965143042848:web:959bd072875b52e20e1545"},app=initializeApp(firebaseConfig),db=getDatabase(app);let seconds=0,timerInterval=null;const userEmail=localStorage.getItem("userEmail"),sanitizedEmail=userEmail?userEmail.replace(/\./g,","):null;function setupInputSync(){[{src:"ans1",dest:"input1"},{src:"ans2",dest:"input2"},{src:"ans3",dest:"input3"},{src:"ans4",dest:"input4"}].forEach(e=>{const t=document.getElementById(e.src),n=document.getElementById(e.dest);t&&n&&(n.readOnly=!0,t.addEventListener("input",()=>{n.value=t.value}))})}function saveLoginTime(){if(!sanitizedEmail)return void console.log("No user email found in localStorage. Skipping login time save.");const e=new Date,t={timestamp:e.toISOString(),date:e.toISOString().split("T")[0],time:e.toTimeString().split(" ")[0]},n=ref(db,`registrations/${sanitizedEmail}/logins`);push(n,t).then(()=>{console.log("Login time saved successfully.")}).catch(e=>{console.error("Error saving login time:",e)})}function enterRound(){const e=document.getElementById("entryScreen"),t=document.getElementById("timer");e.style.display="none",t.style.display="block",document.querySelectorAll(".section").forEach(e=>e.classList.remove("active")),document.getElementById("step-intro").classList.add("active"),setupInputSync(),timerInterval&&clearInterval(timerInterval),timerInterval=setInterval(()=>{seconds++;const e=String(Math.floor(seconds/60)).padStart(2,"0"),n=String(seconds%60).padStart(2,"0");t.textContent=`${e}:${n}`},1e3)}function nextStep(e,t){document.getElementById(e).classList.remove("active");document.getElementById(t).classList.add("active"),"step-p1"===t&&setTimeout(resizeCanvas,100),window.scrollTo(0,0)}function submitPuzzle1(){"system"===document.getElementById("ans1").value.trim().toLowerCase()?nextStep("step-p1","story-bridge"):alert("DECODING FAILED; PATTERN NOT RECOGNIZED")}function submitPuzzle2(){const e=document.getElementById("ans2").value.trim().toLowerCase();"stand"===e||"stands"===e?nextStep("step-p2","story-p3-bridge"):alert("DECODING FAILEDVALIDATION FAILED; TRY AGAIN")}const revealPuzzle3Btn=document.getElementById("revealPuzzle3Btn"),puzzle3Clue=document.getElementById("puzzle3Clue");function submitRound1(){if(!sanitizedEmail)return void alert("User not logged in.");const e=document.getElementById("ans1").value.trim().toLowerCase(),t=document.getElementById("ans2").value.trim().toLowerCase(),n=document.getElementById("ans3").value.trim().toLowerCase(),s=document.getElementById("ans4").value.trim().toLowerCase(),o=document.getElementById("input5").value.trim().toLowerCase(),a=!0,i=new Date,c=i.toISOString().split("T")[0],r=i.toTimeString().split(" ")[0],l={answers:{ans1:e,ans2:t,ans3:n,ans4:s,ans5:o},timeTaken:seconds,completionDate:c,completionTime:r,timestamp:i.toISOString(),correct:a,submitted:!0};set(ref(db,`registrations/${sanitizedEmail}/round1`),l).then(()=>{const e=document.getElementById("submissionStatus");e.textContent="Congratulations. you saved the Spekter.",e.style.display="block",setTimeout(()=>nextStep("step-p5","step-end"),1500)}).catch(e=>alert(e.message))}revealPuzzle3Btn&&puzzle3Clue&&revealPuzzle3Btn.addEventListener("click",()=>{puzzle3Clue.style.display="block",revealPuzzle3Btn.style.display="none"});const canvas=document.getElementById("scratchCanvas"),img=document.getElementById("hiddenImage"),ctx=canvas.getContext("2d");let scratching=!1,lastX=0,lastY=0,completed=!1;function resizeCanvas(){canvas.width=img.clientWidth,canvas.height=img.clientHeight,ctx.fillStyle="#0a0e12",ctx.fillRect(0,0,canvas.width,canvas.height)}function getEventPos(e){const t=canvas.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}}function startScratching(e){scratching=!0;const t=getEventPos(e);lastX=t.x,lastY=t.y}function stopScratching(){scratching=!1,checkScratch()}function doScratching(e){if(!scratching)return;const t=getEventPos(e);ctx.globalCompositeOperation="destination-out",ctx.lineWidth=80,ctx.lineCap="round",ctx.beginPath(),ctx.moveTo(lastX,lastY),ctx.lineTo(t.x,t.y),ctx.stroke(),lastX=t.x,lastY=t.y}function checkScratch(){if(completed)return;const e=ctx.getImageData(0,0,canvas.width,canvas.height).data;let t=0;for(let n=3;n<e.length;n+=4)0===e[n]&&t++;if(t/(e.length/4)*100>=45){completed=!0;const e=document.getElementById("clue");e&&(e.style.display="block")}}img.onload=resizeCanvas,window.addEventListener("resize",resizeCanvas),canvas.addEventListener("mousedown",startScratching),document.addEventListener("mouseup",stopScratching),canvas.addEventListener("mousemove",doScratching),canvas.addEventListener("mouseleave",stopScratching),canvas.addEventListener("touchstart",e=>{e.preventDefault(),startScratching(e.touches[0])}),canvas.addEventListener("touchend",e=>{e.preventDefault(),stopScratching()}),canvas.addEventListener("touchmove",e=>{e.preventDefault(),doScratching(e.touches[0])}),document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("step-p4");if(!e)return;const t=e.querySelector("#revealAudioBtn"),n=e.querySelector("#awaitAudio"),s=e.querySelector("#audioControls"),o=e.querySelector("#pauseBtn"),a=e.querySelector("#resumeBtn"),i=e.querySelector("#downloadBtn");t&&n&&s&&o&&a&&i?(t.addEventListener("click",()=>{n.play().catch(e=>{console.warn("Autoplay blocked or audio error:",e)}),s.style.display="flex",t.style.display="none",o.style.display="inline-block",a.style.display="none"}),o.addEventListener("click",()=>{n.pause(),o.style.display="none",a.style.display="inline-block"}),a.addEventListener("click",()=>{n.play().catch(e=>{console.warn("Resume failed:",e)}),a.style.display="none",o.style.display="inline-block"}),i.addEventListener("click",()=>{const e=document.createElement("a");e.href=n.src,e.download="ciphertrace_audio.mp3",e.click()})):console.warn("Audio elements not found in step-p4. Skipping audio setup.")}),document.addEventListener("DOMContentLoaded",()=>{const e=document.createElement("button");e.textContent="← BACK",e.style.cssText="\n    position: fixed;\n    left: 20px;\n    top: 50%;\n    transform: translateY(-50%);\n    padding: 10px 15px;\n    font-family: 'Orbitron', sans-serif;\n    font-size: 12px;\n    letter-spacing: 2px;\n    border-radius: 8px;\n    border: 1px solid rgba(0,255,255,0.5);\n    background: rgba(0,255,255,0.1);\n    color: #00ffff;\n    cursor: pointer;\n    z-index: 1000;\n    display: none;\n  ";const t=document.createElement("button");t.textContent="FORWARD →",t.style.cssText="\n    position: fixed;\n    right: 20px;\n    top: 50%;\n    transform: translateY(-50%);\n    padding: 10px 15px;\n    font-family: 'Orbitron', sans-serif;\n    font-size: 12px;\n    letter-spacing: 2px;\n    border-radius: 8px;\n    border: 1px solid rgba(0,255,255,0.5);\n    background: rgba(0,255,255,0.1);\n    color: #00ffff;\n    cursor: pointer;\n    z-index: 1000;\n    display: none;\n  ",document.body.appendChild(e),document.body.appendChild(t);const n=["story-p3-bridge","step-p3","story-p4-bridge","step-p4","story-p5-bridge","step-p5"],s=n.indexOf("story-p3-bridge"),o=n.indexOf("step-p3");function a(){const a=document.querySelector(".section.active");if(!a)return;const i=n.indexOf(a.id);return-1===i?(e.style.display="none",void(t.style.display="none")):i===s?(e.style.display="none",t.style.display="block",void(t.onclick=()=>nextStep(a.id,n[i+1]))):i>=o?(i>s?(e.style.display="block",e.onclick=()=>nextStep(a.id,n[i-1])):e.style.display="none",void(i<n.length-1?(t.style.display="block",t.onclick=()=>nextStep(a.id,n[i+1])):t.style.display="none")):void 0}const i=new MutationObserver(a);document.querySelectorAll(".section").forEach(e=>{i.observe(e,{attributes:!0,attributeFilter:["class"]})}),a()}),document.addEventListener("DOMContentLoaded",()=>{saveLoginTime()}),window.enterRound=enterRound,window.nextStep=nextStep,window.submitPuzzle1=submitPuzzle1,window.submitPuzzle2=submitPuzzle2,window.submitRound1=submitRound1;